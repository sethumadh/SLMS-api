// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  APPLICANT
  WAITLISTED
  STUDENT
  ALUMNI
}

enum PaymentMethod {
  ONLINE
  SCHOOL
  // Add more methods as needed
}

enum PaymentStatus {
  PENDING
  PAID
}

enum PaymentType {
  MONTHLY
  TERM
}

model Student {
  id                Int                @id @default(autoincrement())
  enrollments       Enrollment[]
  personalDetails   PersonalDetails?
  parentsDetails    ParentsDetails?
  emergencyContact  EmergencyContact?
  healthInformation HealthInformation?
  otherInformation  OtherInformation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PersonalDetails {
  id        Int     @id @default(autoincrement())
  role      Role    @default(APPLICANT)
  firstName String
  lastName  String
  DOB       String?
  gender    String
  email     String  @unique
  contact   String  @unique
  address   String
  suburb    String
  state     String
  country   String
  postcode  String
  image     String?
  Student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId Int     @unique

  @@index([email])
}

model ParentsDetails {
  id            Int     @id @default(autoincrement())
  fatherName    String
  motherName    String
  parentEmail   String
  parentContact String
  studentId     Int     @unique
  Student       Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model EmergencyContact {
  id            Int     @id @default(autoincrement())
  contactPerson String
  contactNumber String
  relationship  String
  studentId     Int     @unique
  Student       Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model HealthInformation {
  id                        Int     @id @default(autoincrement())
  medicareNumber            String  @unique
  ambulanceMembershipNumber String?
  medicalCondition          String
  allergy                   String
  studentId                 Int     @unique
  Student                   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model OtherInformation {
  id          Int      @id @default(autoincrement())
  otherInfo   String   @default("No information provided")
  declaration String[]
  Student     Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId   Int      @unique
}

model Subject {
  id           Int            @id @default(autoincrement())
  name         String
  isActive     Boolean        @default(true)
  enrollments  Enrollment[]
  fee          Fee? // Fees associated with the subject
  SubjectLevel SubjectLevel[]
  TermSubject  TermSubject[]
}

model Term {
  id          Int           @id @default(autoincrement())
  isPublish   Boolean       @default(true)
  currentTerm Boolean       @default(true)
  name        String        @unique // e.g., Q1-2024
  startDate   DateTime // The start date of the term
  endDate     DateTime // The end date of the term, which would be startDate + 3 months
  enrollments Enrollment[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  TermSubject TermSubject[]
}

model TermSubject {
  termId    Int
  subjectId Int
  term      Term    @relation(fields: [termId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@id([termId, subjectId])
}

model Level {
  id           Int            @id @default(autoincrement())
  name         String         @unique // e.g., Beginner, Intermediate, Advanced
  enrollments  Enrollment[]
  // feedback    Feedback[]
  SubjectLevel SubjectLevel[]
}

model SubjectLevel {
  subjectId   Int
  levelId     Int
  fee         Int
  paymentType PaymentType
  subject     Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  level       Level       @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@id([subjectId, levelId])
}

model Enrollment {
  id        Int      @id @default(autoincrement())
  studentId Int
  subjectId Int
  levelId   Int
  termId    Int
  dueDate   DateTime // Add this line to store due date -> this will be term end date or expire date

  student    Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject    Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  level      Level        @relation(fields: [levelId], references: [id])
  term       Term         @relation(fields: [termId], references: [id])
  FeePayment FeePayment[]

  @@unique([studentId, subjectId, levelId, termId])
}

model Fee {
  id     Int @id @default(autoincrement())
  amount Int
  // dueDate is removed since it's calculated from Term's startDate

  Subject     Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  subjectId   Int         @unique
  paymentType PaymentType // Indicates if the fee is paid monthly or per term
}

model FeePayment {
  id           Int           @id @default(autoincrement())
  enrollmentId Int
  dueDate      DateTime
  paidDate     DateTime? // Nullable, set when payment is made
  amount       Int
  status       PaymentStatus
  method       PaymentMethod // New field for payment method
  enrollment   Enrollment    @relation(fields: [enrollmentId], references: [id])
}

// model Feedback {
//   id        Int      @id @default(autoincrement())
//   feedback  String
//   studentId Int
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
//   Level     Level?   @relation(fields: [levelId], references: [id])
//   levelId   Int?
//   Student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
// }
